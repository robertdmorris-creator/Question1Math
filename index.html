import React, { useState, useRef } from 'react';
import { User, Flag, Scissors, Calculator, RefreshCw, CheckCircle, ArrowRight, Eye, EyeOff, HelpCircle } from 'lucide-react';

export default function RelayRaceLesson() {
  const [step, setStep] = useState(1);
  
  // Step 1 State
  const [showMileMarkers, setShowMileMarkers] = useState(false);
  const [showCutLines, setShowCutLines] = useState(false);

  // Step 2 State
  const [splitPosition, setSplitPosition] = useState(0);
  const [hasChecked, setHasChecked] = useState(false);
  const [feedback, setFeedback] = useState("");

  // Step 3 State
  const [showEquation, setShowEquation] = useState(false);
  const [showExplanation, setShowExplanation] = useState(false);

  const trackRef = useRef(null);

  // Reset function
  const reset = () => {
    setStep(1);
    setSplitPosition(0);
    setFeedback("");
    setHasChecked(false);
    setShowMileMarkers(false);
    setShowCutLines(false);
    setShowEquation(false);
    setShowExplanation(false);
  };

  // Step 2: Handle Slider Change (The "Cut") - No instant feedback now
  const handleSliderChange = (e) => {
    const val = parseFloat(e.target.value);
    setSplitPosition(val);
    setHasChecked(false); // Reset check status when moving
    setFeedback("");
  };

  // Step 2: Check Answer Logic
  const checkAnswer = () => {
    setHasChecked(true);
    if (splitPosition >= 1.45 && splitPosition <= 1.55) {
      setFeedback("Perfect! That's exactly halfway.");
      // Snap to exactly 1.5 for cleanliness if they are close
      setSplitPosition(1.5);
    } else if (splitPosition < 1.5) {
      setFeedback("Not quite. Benny doesn't have enough distance yet.");
    } else {
      setFeedback("Not quite. Mickey has too little distance.");
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
      
      {/* Header / Context */}
      <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-sm p-6 mb-6 border-l-8 border-blue-500">
        <h1 className="text-3xl md:text-4xl font-bold text-slate-900 mb-2 flex items-center gap-2">
          <Flag className="text-blue-500" size={40} /> Relay Race Challenge
        </h1>
        <p className="text-xl text-slate-600">
          <strong>Problem:</strong> Benny and Mickey are running a <span className="font-bold text-blue-600">3-mile</span> relay race. 
          They each must run the <span className="italic">same distance</span>.
        </p>
      </div>

      {/* Main Interactive Stage */}
      <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        
        {/* Step Navigation */}
        <div className="bg-slate-100 p-4 flex flex-wrap gap-2 border-b border-slate-200">
          {[1, 2, 3].map((num) => (
            <button
              key={num}
              onClick={() => setStep(num)}
              className={`px-6 py-3 rounded-full text-lg font-bold transition-all ${
                step === num 
                  ? 'bg-blue-600 text-white shadow-md transform scale-105' 
                  : 'bg-white text-slate-500 hover:bg-blue-50'
              }`}
            >
              Step {num}: {num === 1 ? 'Visualize' : num === 2 ? 'Split' : 'Solve'}
            </button>
          ))}
          <button onClick={reset} className="ml-auto flex items-center gap-2 text-slate-500 hover:text-blue-600 text-base font-medium px-4">
            <RefreshCw size={20} /> Reset
          </button>
        </div>

        {/* Canvas Area */}
        <div className="p-8 min-h-[500px] flex flex-col items-center justify-start pt-16 relative bg-gradient-to-b from-blue-50 to-white">
          
          {/* THE TRACK VISUALIZATION */}
          <div className="w-full max-w-4xl relative mb-20 select-none" ref={trackRef}>
            
            {/* Mile Markers (Top) */}
            <div className="flex justify-between w-full text-slate-500 font-bold font-mono text-xl mb-4 px-[2px]">
              <span className="text-3xl">0 mi</span>
              
              {/* Hidden/Revealed Middle Markers */}
              <div className={`flex-1 flex justify-around transition-opacity duration-500 ${showMileMarkers ? 'opacity-100' : 'opacity-0'}`}>
                <span>1 mi</span>
                <span>2 mi</span>
              </div>

              <span className="text-3xl">3 mi</span>
            </div>

            {/* The Physical Track Bar */}
            <div className="h-20 w-full bg-emerald-500 rounded-full relative shadow-inner border-4 border-emerald-600 flex items-center">
              
              {/* Track Cut Lines (Conditional) */}
              {showCutLines && (
                <>
                  <div className="absolute left-1/3 h-full w-1 bg-white/60 dashed-line z-10"></div>
                  <div className="absolute left-2/3 h-full w-1 bg-white/60 dashed-line z-10"></div>
                </>
              )}

              {/* Step 1: Runners at START context */}
              {step === 1 && (
                <div className="absolute -left-8 top-1/2 -translate-y-1/2 flex flex-col gap-2 z-20">
                  <div className="flex flex-col items-center">
                    <User size={40} className="text-purple-600 fill-current drop-shadow-md" />
                    <span className="text-sm font-bold bg-white px-2 py-0.5 rounded shadow text-purple-600">Benny</span>
                  </div>
                  <div className="flex flex-col items-center">
                    <User size={40} className="text-orange-600 fill-current drop-shadow-md" />
                    <span className="text-sm font-bold bg-white px-2 py-0.5 rounded shadow text-orange-600">Mickey</span>
                  </div>
                </div>
              )}

              {/* Step 2 & 3: The Colored Splits */}
              {step > 1 && (
                <>
                  {/* Benny's Section */}
                  <div 
                    className="h-full bg-purple-500 rounded-l-full flex items-center justify-center text-white text-2xl font-bold transition-all duration-200"
                    style={{ width: `${(splitPosition / 3) * 100}%` }}
                  >
                    {splitPosition > 0.5 && "Benny"}
                  </div>
                  
                  {/* Mickey's Section */}
                  <div 
                    className="h-full bg-orange-500 rounded-r-full flex items-center justify-center text-white text-2xl font-bold flex-1 transition-all duration-200"
                  >
                    {(3 - splitPosition) > 0.5 && "Mickey"}
                  </div>

                  {/* The Draggable Splitter */}
                  <div 
                    className="absolute top-0 bottom-0 w-1 cursor-col-resize z-20 group"
                    style={{ left: `${(splitPosition / 3) * 100}%` }}
                  >
                    <div className="absolute -top-10 -left-6 bg-white p-3 rounded-full shadow-xl border-2 border-slate-200 cursor-grab active:cursor-grabbing transform group-hover:scale-110 transition-transform">
                      <Scissors size={28} className="text-slate-700" />
                    </div>
                    <div className="h-32 w-1.5 bg-slate-800 absolute -top-6 left-0"></div>
                  </div>
                </>
              )}
            </div>
          </div>

          {/* CONTROLS & EXPLANATION AREA */}
          <div className="w-full max-w-4xl bg-white/80 backdrop-blur rounded-xl p-8 shadow-sm border border-slate-100">
            
            {/* Step 1 Content */}
            {step === 1 && (
              <div className="flex flex-col items-center gap-6">
                <p className="text-2xl text-slate-700 text-center">
                  How can we split this <span className="font-bold">3-mile</span> race for 2 friends?
                </p>
                
                <div className="flex gap-4 flex-wrap justify-center">
                  <button 
                    onClick={() => setShowCutLines(!showCutLines)}
                    className={`px-6 py-3 rounded-lg font-semibold border-2 flex items-center gap-2 transition-colors ${
                      showCutLines ? 'bg-emerald-100 border-emerald-500 text-emerald-700' : 'bg-white border-slate-300 text-slate-600 hover:border-emerald-400'
                    }`}
                  >
                    {showCutLines ? <EyeOff size={20}/> : <Eye size={20}/>}
                    {showCutLines ? 'Hide Cut Lines' : 'Show Cut Lines'}
                  </button>

                  <button 
                    onClick={() => setShowMileMarkers(!showMileMarkers)}
                    className={`px-6 py-3 rounded-lg font-semibold border-2 flex items-center gap-2 transition-colors ${
                      showMileMarkers ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-white border-slate-300 text-slate-600 hover:border-blue-400'
                    }`}
                  >
                    {showMileMarkers ? <EyeOff size={20}/> : <Eye size={20}/>}
                    {showMileMarkers ? 'Hide Mile Marks' : 'Add Mile Marks'}
                  </button>
                </div>

                <button 
                  onClick={() => setStep(2)} 
                  className="mt-8 bg-blue-600 hover:bg-blue-700 text-white text-xl px-8 py-4 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-transform hover:-translate-y-1"
                >
                  Let's Split It <ArrowRight size={24} />
                </button>
              </div>
            )}

            {/* Step 2 Content */}
            {step === 2 && (
              <div className="text-center">
                 <label className="block text-lg font-bold text-slate-500 mb-4 uppercase tracking-wide">
                  Drag the scissors to cut the race in half
                </label>
                
                <input 
                  type="range" 
                  min="0" 
                  max="3" 
                  step="0.05"
                  value={splitPosition}
                  onChange={handleSliderChange}
                  className="w-full h-4 bg-slate-200 rounded-lg appearance-none cursor-pointer mb-8 accent-blue-600"
                />
                
                {/* BIG Text Stats */}
                <div className="grid grid-cols-2 gap-4 mb-8">
                  <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-100">
                    <div className="text-purple-600 text-sm font-bold uppercase mb-1">Benny Runs</div>
                    <div className="text-5xl font-bold text-slate-800">{splitPosition.toFixed(2)} <span className="text-xl text-slate-400">mi</span></div>
                  </div>
                  <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-100">
                    <div className="text-orange-600 text-sm font-bold uppercase mb-1">Mickey Runs</div>
                    <div className="text-5xl font-bold text-slate-800">{(3 - splitPosition).toFixed(2)} <span className="text-xl text-slate-400">mi</span></div>
                  </div>
                </div>

                <div className="flex justify-center gap-4 mb-6">
                    <button 
                        onClick={checkAnswer}
                        className="bg-indigo-600 hover:bg-indigo-700 text-white text-lg px-8 py-3 rounded-lg font-bold shadow-md transition-colors flex items-center gap-2"
                    >
                        <HelpCircle size={24} /> Check Answer
                    </button>
                </div>

                {hasChecked && (
                  <div className={`p-4 rounded-xl text-xl font-bold mb-6 animate-bounce-short ${
                      feedback.includes("Perfect") 
                      ? 'bg-green-100 text-green-800 border-2 border-green-200' 
                      : 'bg-red-50 text-red-800 border-2 border-red-100'
                  }`}>
                    {feedback.includes("Perfect") && <CheckCircle size={28} className="inline mr-3 mb-1"/>}
                    {feedback}
                  </div>
                )}

                {feedback.includes("Perfect") && (
                   <button 
                   onClick={() => setStep(3)} 
                   className="bg-green-600 hover:bg-green-700 text-white text-xl px-10 py-4 rounded-xl font-bold flex items-center gap-2 mx-auto animate-pulse shadow-lg"
                 >
                   See the Math <Calculator size={24} />
                 </button>
                )}
              </div>
            )}

            {/* Step 3 Content (The Solution) */}
            {step === 3 && (
              <div className="grid md:grid-cols-2 gap-12 items-start animate-fade-in">
                
                {/* The Expression */}
                <div className="bg-slate-50 p-8 rounded-2xl border-2 border-slate-200 text-center relative overflow-hidden">
                  <h3 className="text-lg font-bold text-slate-400 uppercase mb-6">The Math Expression</h3>
                  
                  {!showEquation ? (
                    <button 
                        onClick={() => setShowEquation(true)}
                        className="bg-white border-2 border-dashed border-slate-300 text-slate-500 w-full py-12 rounded-xl hover:bg-slate-50 hover:border-blue-300 hover:text-blue-500 transition-all flex flex-col items-center gap-2"
                    >
                        <Eye size={32} />
                        <span className="font-bold">Reveal Equation</span>
                    </button>
                  ) : (
                    <div className="animate-scale-in">
                        <div className="text-5xl font-bold text-slate-800 flex items-center justify-center gap-4 mb-8">
                            <span>3</span>
                            <span className="text-blue-500">÷</span>
                            <span>2</span>
                        </div>
                        <div className="text-4xl text-slate-600 font-serif flex items-center justify-center">
                            <div className="flex flex-col items-center">
                                <span className="border-b-4 border-slate-800 px-4 mb-1">3</span>
                                <span className="px-4">2</span>
                            </div>
                        </div>
                    </div>
                  )}
                </div>

                {/* The Explanation */}
                <div className="space-y-6">
                  <h3 className="text-2xl font-bold text-slate-800">Why is the answer 1.5?</h3>
                  
                  {!showExplanation ? (
                      <button 
                        onClick={() => setShowExplanation(true)}
                        className="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 font-bold py-4 rounded-xl border-2 border-blue-200 flex items-center justify-center gap-2 transition-colors"
                      >
                          <HelpCircle size={24} />
                          Reveal Explanation
                      </button>
                  ) : (
                    <div className="animate-fade-in space-y-4">
                        <ul className="space-y-4 text-lg text-slate-600">
                            <li className="flex gap-3 items-start">
                            <div className="bg-green-100 p-1 rounded-full mt-1"><CheckCircle size={18} className="text-green-600" /></div>
                            <span>We started with <strong className="text-slate-900">3 whole miles</strong>.</span>
                            </li>
                            <li className="flex gap-3 items-start">
                            <div className="bg-green-100 p-1 rounded-full mt-1"><CheckCircle size={18} className="text-green-600" /></div>
                            <span>We split them between <strong className="text-slate-900">2 friends</strong>.</span>
                            </li>
                            <li className="flex gap-3 items-start">
                            <div className="bg-green-100 p-1 rounded-full mt-1"><CheckCircle size={18} className="text-green-600" /></div>
                            <span>1.5 is the same as <strong className="text-green-700">1 and a half</strong> (1½).</span>
                            </li>
                        </ul>
                        <div className="mt-6 p-6 bg-indigo-50 text-indigo-900 rounded-xl text-center text-xl font-bold border-2 border-indigo-100 shadow-sm">
                            Answer: 1.5 miles
                        </div>
                    </div>
                  )}
                </div>

              </div>
            )}

          </div>
        </div>
      </div>
    </div>
  );
}
